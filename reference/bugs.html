<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Bugs</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Bugs">
<table class="header">
<tr>
<td class="logo"><a href="../index.html">Spectrum ROM</a></td>
<td class="page-header">Bugs</td>
</tr>
</table>
<ul class="contents">
<li><a href="#noStepForward">No step forward</a></li>
<li><a href="#noStepBack">No step back</a></li>
<li><a href="#stepBackTooFar">A step back too far</a></li>
<li><a href="#savingASimpleString">Saving a simple string</a></li>
<li><a href="#neverendingRestore">The neverending RESTORE</a></li>
<li><a href="#curseTheCursor">Curse the cursor</a></li>
<li><a href="#str$AndSmallNumbers">STR$ and small numbers</a></li>
<li><a href="#dontCloseTheStreams">Don't close the streams</a></li>
<li><a href="#pressAlmostAnyKey">Press (almost) any key</a></li>
<li><a href="#anythingEqualsSCREEN$xy">Anything equals SCREEN$ (x,y)</a></li>
<li><a href="#34thBitOfDivision">The 34th bit of division</a></li>
<li><a href="#troubleWith-65536">The trouble with -65536</a></li>
</ul>
<div><span id="noStepForward"></span></div>
<div class="box box-1">
<div class="box-title">No step forward</div>
<div class="paragraph">
Consider this PRINT command:
</div>
<div class="paragraph">
<code>PRINT 12;CHR$ 9;34</code>
</div>
<div class="paragraph">
You might, because of the cursor-right control character (CHR$ 9) between '12'
and '34', expect it to print:
</div>
<div class="paragraph">
<code>12 34</code>
</div>
<div class="paragraph">
But in fact it prints:
</div>
<div class="paragraph">
<code>1234</code>
</div>
<div class="paragraph">
The reason is that the routine at <a href="../asm/0A3D.html">PO_RIGHT</a>, which is responsible for handling
CHR$ 9, does not update the print position after overprinting a space to the
right of the '2', and so effectively prints nothing at all.
</div>
<div class="paragraph">
Note, however, that even if the print position were updated, CHR$ 9 would still
not be a true cursor-right control character, because it overprints a space
using the current colours rather than leaving the colours as they are. The
following PRINT command demonstrates this bug:
</div>
<div class="paragraph">
<code>PRINT AT 0,0;1; INK 2;AT 0,0;CHR$ 9</code>
</div>
</div>
<div><span id="noStepBack"></span></div>
<div class="box box-2">
<div class="box-title">No step back</div>
<div class="paragraph">
Consider the following PRINT commands:
</div>
<div class="paragraph">
<div><code>PRINT 1</code></div>
<div><code>PRINT CHR$ 8;2</code></div>
<div><code>PRINT CHR$ 8;3</code></div>
</div>
<div class="paragraph">
They should print '2' at the right end of the top line of the display - because
of the cursor-left character (CHR$ 8) before the '2' - but instead the '2' is
printed at the beginning of the second line, as if the CHR$ 8 were not there.
However, the '3' is (correctly) printed at the right end of the second line.
</div>
<div class="paragraph">
The reason is that the instruction at <a href="../asm/0A23.html#0A32">0A32</a> is 'LD A,$18' instead of
'LD A,$19', which prevents CHR$ 8 from moving the print position up to
the top line of the display.
</div>
</div>
<div><span id="stepBackTooFar"></span></div>
<div class="box box-1">
<div class="box-title">A step back too far</div>
<div class="paragraph">
In addition to sometimes not working when it should, the cursor-left character
(CHR$ 8) also sometimes works when it shouldn't - specifically, when the print
position is at the top-left of the screen. For example:
</div>
<div class="paragraph">
<code>PRINT AT 0,0;CHR$ 8;12</code>
</div>
<div class="paragraph">
Here the CHR$ 8 should have no effect, but instead the '1' is printed at
(-1,0), which the ROM calculates to be at address 58FF, or (7,31) in the
attribute file.
</div>
<div class="paragraph">
The reason, again, is that the instruction at <a href="../asm/0A23.html#0A32">0A32</a> is 'LD A,$18'
instead of 'LD A,$19', which allows CHR$ 8 to move the print position up
beyond the top line of the display.
</div>
</div>
<div><span id="savingASimpleString"></span></div>
<div class="box box-2">
<div class="box-title">Saving a simple string</div>
<div class="paragraph">
It is possible to save a simple string (as opposed to an array) to tape, but it
cannot be restored. For example:
</div>
<div class="paragraph">
<div><code>LET a$="12"</code></div>
<div><code>SAVE "a" DATA a$()</code></div>
</div>
<div class="paragraph">
saves the simple string variable a$ to tape without giving an error. When the
same variable is loaded from tape:
</div>
<div class="paragraph">
<code>LOAD "" DATA a$()</code>
</div>
<div class="paragraph">
no error is given until a$ is accessed - both <code>PRINT a$</code> and
<code>PRINT a$(1)</code> result in a '3 Subscript wrong' error.
</div>
<div class="paragraph">
The reason it's possible to save a simple string to tape is that the routine at
<a href="../asm/0605.html">SAVE_ETC</a>, when it finds the string variable to be saved, does not check whether
it is an array.
</div>
</div>
<div><span id="neverendingRestore"></span></div>
<div class="box box-1">
<div class="box-title">The neverending RESTORE</div>
<div class="paragraph">
When the following program is run, the Spectrum will enter an infinite loop:
</div>
<div class="paragraph">
<code>10 RESTORE 60000</code>
</div>
<div class="paragraph">
The reason is that the routine at <a href="../asm/19B8.html">NEXT_ONE</a> - which is called from <a href="../asm/196E.html">LINE_ADDR</a> to
find the next line in the BASIC program - does not stop at the end of the BASIC
program (if there even is one), but keeps going through the variables area and
the rest of the RAM. Depending on the contents of the RAM, the routine can end
up examining the same memory area over and over again, never finding anything
that looks like a BASIC line with a suitably high number.
</div>
</div>
<div><span id="curseTheCursor"></span></div>
<div class="box box-2">
<div class="box-title">Curse the cursor</div>
<div class="paragraph">
In some circumstances, pressing EDIT can bring the current line cursor down to
the editing area along with the current line, and the cursor must be removed
before the line is re-entered. For example, type in the following program,
pressing ENTER where shown:
</div>
<div class="paragraph">
<div><code>10 PRINT&lt;ENTER&gt;</code></div>
<div><code>11&lt;ENTER&gt;</code></div>
</div>
<div class="paragraph">
Then press EDIT, and see line 10 come down to the editing area with the cursor
in tow.
</div>
<div class="paragraph">
The reason this happens is that the routine at <a href="../asm/0FA9.html">ED_EDIT</a> decrements the line
number at <a href="../asm/5C49.html">E-PPC</a> (from 11 to 10) so as to avoid printing the cursor,
but doesn't take into account that the number of the line that will be brought
down for editing is one less than its current value.
</div>
</div>
<div><span id="str$AndSmallNumbers"></span></div>
<div class="box box-1">
<div class="box-title">STR$ and small numbers</div>
<div class="paragraph">
Because of a bug in the handling of the calculator stack at <a href="../asm/2DE3.html#2E24">PF_SMALL</a>, a binary
expression with STR$ on the right hand side is evaluated as if its left hand
side is empty. For example:
</div>
<div class="paragraph">
<code>PRINT "2"+STR$ 0.5</code>
</div>
<div class="paragraph">
prints '0.5' instead of '20.5'.
</div>
<div class="paragraph">
Note that the bug is triggered only if the argument of STR$ is a non-zero
number strictly between -1 and 1.
</div>
</div>
<div><span id="dontCloseTheStreams"></span></div>
<div class="box box-2">
<div class="box-title">Don't close the streams</div>
<div class="paragraph">
It can be dangerous to close a stream, especially if it's aleady been closed or
was never opened. For example, on a freshly booted Spectrum:
</div>
<div class="paragraph">
<code>CLOSE #4</code>
</div>
<div class="paragraph">
makes the computer hang.
</div>
<div class="paragraph">
The root cause is that there is no end marker in the <a href="../asm/1716.html">close stream
lookup table</a>. This makes the 'JP (HL)' at the end of the routine at
<a href="../asm/1701.html">CLOSE_2</a> jump to <a href="../asm/1736.html#175B">175B</a>, and the 'RET' that follows at 175C causes an
indirect jump to 5C1E (an address pushed onto the stack earlier at
<a href="../asm/1701.html#1701">1701</a>). After proceeding through the RAM at 5C1E onwards,
and disabling interrupts along the way, the Spectrum finally hangs on the
'HALT' instruction at <a href="../asm/12A2.html#1303">MAIN_4</a>.
</div>
<div class="paragraph">
If there were an end marker ($00) in the close stream lookup table, the
'JP (HL)' at the end of the routine at <a href="../asm/1701.html">CLOSE_2</a> would jump to <a href="../asm/171C.html">CLOSE_STR</a>, the
'RET' that follows at 171D would return to <a href="../asm/16E5.html#16EB">16EB</a>, and the stream would
be closed successfully.
</div>
</div>
<div><span id="pressAlmostAnyKey"></span></div>
<div class="box box-1">
<div class="box-title">Press (almost) any key</div>
<div class="paragraph">
Not every key besides 'n', 'N', BREAK and STOP will work at the 'scroll?' and
'Start tape then press any key.' prompts: pressing CAPS LOCK, or GRAPHICS, or
CAPS SHIFT and SYMBOL SHIFT together at these prompts causes the previous edit
line to appear at the bottom of the screen instead.
</div>
<div class="paragraph">
This is because the routine at <a href="../asm/10A8.html">KEY_INPUT</a>, which is used (via <a href="../asm/15D4.html">WAIT_KEY</a>) to decode a
keypress, copies the edit line to the lower part of the screen when the mode
changes (from 'L').
</div>
</div>
<div><span id="anythingEqualsSCREEN$xy"></span></div>
<div class="box box-2">
<div class="box-title">Anything equals SCREEN$ (x,y)</div>
<div class="paragraph">
Some care is needed when using SCREEN$, because it doesn't always work as you
would expect. For example:
</div>
<div class="paragraph">
<code>IF ""=SCREEN$ (0,0) THEN PRINT "?"</code>
</div>
<div class="paragraph">
will print "?" no matter what is on the screen at (0,0) at the time.
</div>
<div class="paragraph">
The reason is that the routine at <a href="../asm/2535.html">S_SCRN_S</a> exits via <a href="../asm/2AB1.html#2AB2">STK_STO</a>, which results in
the character found at (0,0) being stored on the calculator stack twice instead
of just once. So when the '=' operation above is performed, the last two items
on the stack - the two copies of SCREEN$ (0,0) - are equal, and the result of
the operation is always true, regardless of what's on the left hand side of the
equation.
</div>
<div class="paragraph">
Note that the calculator stack is cleared before each statement of a BASIC
program (or the edit line) is executed, so the bug is confined to the statement
that contains SCREEN$, and will not affect any other statements.
</div>
</div>
<div><span id="34thBitOfDivision"></span></div>
<div class="box box-1">
<div class="box-title">The 34th bit of division</div>
<div class="paragraph">
In the division loop at <a href="../asm/31AF.html#31D2">DIV_LOOP</a>, the 34th bit of the quotient is always set to
0, meaning that some results - such as 1/10 and 1/1000 - are not rounded up as
they should be. For example:
</div>
<div class="paragraph">
<code>PRINT 1/2-.5</code>
</div>
<div class="paragraph">
prints '2.3283064E-10' instead of '0', because while '1/2' is calculated
correctly, '.5' is evaluated as '5 * 1/10', which is not calculated correctly.
Specifically, '1/10' is represented as 7D 4C CC CC CC (0.0999999999767) in
floating point form, but if the 34th bit were included, it would be rounded up
to 7D 4C CC CC CD (0.100000000006), which is more accurate.
</div>
<div class="paragraph">
The problem is caused by the jump at <a href="../asm/31AF.html#31FF">31FF</a>, which should be to <a href="../asm/31AF.html#31DB">DIV_34TH</a>
instead of <a href="../asm/31AF.html#31E2">DIV_START</a>.
</div>
</div>
<div><span id="troubleWith-65536"></span></div>
<div class="box box-2">
<div class="box-title">The trouble with -65536</div>
<div class="paragraph">
In some circumstances, the number -65536 is stored in short form instead of
full floating point form, which causes problems. For example:
</div>
<div class="paragraph">
<code>PRINT -65535-1</code>
</div>
<div class="paragraph">
prints '-1E-38', and:
</div>
<div class="paragraph">
<code>PRINT INT -65536</code>
</div>
<div class="paragraph">
prints '-1'.
</div>
<div class="paragraph">
The first of these problems is caused by the routine at <a href="../asm/3014.html">addition</a>, which fails to
detect an overflow when adding two small negative integers whose sum is -65536.
Specifically, when <a href="../asm/3014.html#302B">302B</a> is reached, the carry flag is set, <span class="register">A</span> holds
$FF (the sign byte of the second number), and <span class="register">(HL)</span> also holds $FF
(the sign byte of the first number). Then:
</div>
<div class="paragraph">
<table class="asm">
<tr>
<td class="address-1" colspan="1" rowspan="1">302B</td>
<td class="instruction" colspan="1" rowspan="1">ADC A,(HL)</td>
<td class="comment-11" colspan="1" rowspan="1"><span class="register">A</span>=$FF ($FF+$FF+carry).</td>
</tr>
<tr>
<td class="address-1" colspan="1" rowspan="1">302C</td>
<td class="instruction" colspan="1" rowspan="1">RRCA</td>
<td class="comment-11" colspan="1" rowspan="1"><span class="register">A</span>=$FF, carry flag set.</td>
</tr>
<tr>
<td class="address-1" colspan="1" rowspan="1">302D</td>
<td class="instruction" colspan="1" rowspan="1">ADC A,$00</td>
<td class="comment-11" colspan="1" rowspan="1"><span class="register">A</span>=$00.</td>
</tr>
<tr>
<td class="address-1" colspan="1" rowspan="1">302F</td>
<td class="instruction" colspan="1" rowspan="1">JR NZ,<a href="../asm/3014.html#303C">ADDN_OFLW</a></td>
<td class="comment-11" colspan="1" rowspan="1">This jump is not made.</td>
</tr>
</table>
</div>
<div class="paragraph">
The result is then stored as 00 FF 00 00 00, which other ROM routines do not
always handle correctly.
</div>
<div class="paragraph">
The second problem is caused by the routine at <a href="../asm/3214.html">truncate</a>. Specifically, the
section of code at <a href="../asm/3214.html#3225">3225</a> checks whether the argument <i>x</i> satisfies
-65537&lt;<i>x</i>&lt;=-65536; if it does, its floating point form is
(erroneously) modified to 00 FF 00 00 00. (-65537 in floating point form is
91 80 00 80 00, which explains why the mask 0x80 is used when testing the
fourth byte of <i>x</i> at <a href="../asm/3214.html#3230">3230</a>.)
</div>
</div>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20170519</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2017 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>